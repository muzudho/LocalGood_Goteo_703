────────────────────────────────────────
2016-02-22 22:22

    解説
        データベース作成

    実行
        CREATE SCHEMA `localgood703` DEFAULT CHARACTER SET utf8 COLLATE utf8_bin ;

────────────────────────────────────────
2016-02-22 23:54

/controller/admin.php   201-203

    解説
        「Text::」の脱字。

    ×
                    'list' => array('label' => _('Estado del envio automatico'), 'item' => false),
                    'init' => array('label' => _('Iniciando un nuevo boletin'), 'item' => false),
                    'init' => array('label' => _('Viendo listado completo'), 'item' => true)

    ○
                    'list' => array('label' => Text::_('Estado del envio automatico'), 'item' => false),
                    'init' => array('label' => Text::_('Iniciando un nuevo boletin'), 'item' => false),
                    'init' => array('label' => Text::_('Viendo listado completo'), 'item' => true)

────────────────────────────────────────
2016-02-23 00:19

/core/model.php		63-95,108-109

	解説
		ＳＱＬクエリーのテーブル名の頭に「`gt_lg-common`.」というテーブル名修飾を
		付けるフィルターをコメントアウト。

	×
        /**
         *
         */
        protected function queryFilter($query){

            $_query = $query;

            if (!empty($_query)){

                $ret = preg_match_all('/user([A-Za-z_]*)\./s',$_query, $_match);
                if ($ret > 0){
                    $_matched = array_unique($_match[0]);
                    foreach ( $_matched as $_m ){
                        $_query = preg_replace("/" . preg_quote($_m) ."/", "`gt_lg-common`." . $_m, $_query);
                    }
                }

                $ret = preg_match_all('/(FROM|JOIN|TABLE|INTO|INSERT|UPDATE|DELETE|REPLACE|\()\s+user([A-Za-z_]*)/s', $_query, $_match);
                if ($ret > 0){
                    $_matched = array_unique($_match[0]);
                    foreach ( $_matched as $_m ){
                        $trim_m = preg_replace("/\s+/", " ", $_m);
                        $_e = explode(' ', $trim_m);
                        if (isset($_e[1])  && (strpos($_e[1], 'user') !== false)){
                            $_e[1] = '`gt_lg-common`.' . $_e[1];
                            $_s = implode(' ', $_e);
                            $_query = preg_replace("/" . preg_quote($_m) ."/", $_s, $_query);
                        }
                    }
                }
            }
            return $_query;
        }

	○
         /**
          *
          */
         protected function queryFilter($query){

             $_query = $query;
// 
//             if (!empty($_query)){
// 
//                 $ret = preg_match_all('/user([A-Za-z_]*)\./s',$_query, $_match);
//                 if ($ret > 0){
//                     $_matched = array_unique($_match[0]);
//                     foreach ( $_matched as $_m ){
//                         $_query = preg_replace("/" . preg_quote($_m) ."/", "`gt_lg-common`." . $_m, $_query);
//                     }
//                 }
// 
//                 $ret = preg_match_all('/(FROM|JOIN|TABLE|INTO|INSERT|UPDATE|DELETE|REPLACE|\()\s+user([A-Za-z_]*)/s', $_query, $_match);
//                 if ($ret > 0){
//                     $_matched = array_unique($_match[0]);
//                     foreach ( $_matched as $_m ){
//                         $trim_m = preg_replace("/\s+/", " ", $_m);
//                         $_e = explode(' ', $trim_m);
//                         if (isset($_e[1])  && (strpos($_e[1], 'user') !== false)){
//                             $_e[1] = '`gt_lg-common`.' . $_e[1];
//                             $_s = implode(' ', $_e);
//                             $_query = preg_replace("/" . preg_quote($_m) ."/", $_s, $_query);
//                         }
//                     }
//                 }
//             }
             return $_query;
         }

────────────────────────────────────────
2016-02-23 00:36

	解説
		ローカルグッド横浜の拠点を入れておくフィールドの追加。

	実行
		ALTER TABLE `localgood703`.`user` 
		ADD COLUMN `home` VARCHAR(50) NOT NULL COMMENT '(^q^)Add 2016-02-23' AFTER `node`;

	実行（てきとう）
		UPDATE `localgood703`.`user` SET `home`='LOCAL GOOD FUKUOKA' WHERE `id`='root';

────────────────────────────────────────
2016-02-23 01:29

	解説
		ローカルグッド横浜版GOTEOに追加されている、管理者の操作ログを
		記録していくテーブル。

	実行
		CREATE TABLE user_login_log
		(
		    user VARCHAR(50) NOT NULL,
		    node VARCHAR(50) NOT NULL,
		    datetime TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
		    token VARCHAR(50) NOT NULL,
		    expiration_date TIMESTAMP DEFAULT '0000-00-00 00:00:00' NOT NULL,
		    CONSTRAINT `PRIMARY` PRIMARY KEY (user, node)
		);

────────────────────────────────────────
2016-02-23 02:32

/local-settings.php

	解説
		データベース名を指定する項目が追加されていた。

	設定例
		// LocalGood Common Authentication Database
		define('COMMON_AUTH_DB_SCHEMA'		, 'localgood703');	// dbname=...

────────────────────────────────────────

